stages:
  - generate_uml
  - deploy_pages

generate_uml:
  stage: generate_uml
  cache:
    key: plantuml-only-clean
    paths:
      - plantuml.jar
  before_script:
    - |
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é Java
      if command -v java &> /dev/null; then
        echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é Java"
        java -version
      else
        echo "‚ùå Java –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Java."
        exit 1
      fi
    - |
      if [ ! -f "plantuml.jar" ]; then
        echo "PlantUML –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–≥—Ä—É–∂–∞—é..."
        wget -q https://github.com/plantuml/plantuml/releases/download/v1.2024.5/plantuml-1.2024.5.jar -O plantuml.jar || curl -L -o plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2024.5/plantuml-1.2024.5.jar
      else
        echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º PlantUML –∏–∑ –∫—ç—à–∞"
      fi
  script:
    - mkdir -p public
    - echo "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>PlantUML Diagrams</title><style>body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5;}h1{color:#333;}a{display:block;margin:10px 0;color:#0066cc;text-decoration:none;padding:8px;background:white;border-radius:4px;}a:hover{background:#e8f4f8;}</style></head><body><h1>PlantUML Diagrams</h1>" > public/index.html
    - |
      for file in sequences/*.puml; do
        if [ -f "$file" ]; then
          filename=$(basename "$file" .puml)
          echo "Processing: $file"
          cd sequences
          java -jar ../plantuml.jar -tpng "$filename.puml"
          mv "$filename.png" ../public/
          cd ..
          echo "<a href='$filename.png' target='_blank'>üìä $filename</a>" >> public/index.html
        fi
      done
    - echo "</body></html>" >> public/index.html
    - ls -la public/
    - echo "=== –ü–£–ë–õ–ò–ß–ù–´–ï –°–°–´–õ–ö–ò –ù–ê –î–ò–ê–ì–†–ê–ú–ú–´ ==="
    - echo "–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫–∏:"
    - |
      for img in public/*.png; do
        if [ -f "$img" ]; then
          filename=$(basename "$img")
          echo "üìä $filename:"
          echo "   https://git.melonfashion.ru/befree/qa/befree-diagrams/-/jobs/latest/artifacts/file/public/$filename"
          echo ""
        fi
      done
  artifacts:
    paths:
      - public/
    expire_in: 30 days

pages:
  stage: deploy_pages
  dependencies:
    - generate_uml
  script:
    - echo "–î–µ–ø–ª–æ–π –Ω–∞ GitLab Pages..."
    - ls -la public/
  artifacts:
    paths:
      - public