stages:
  - generate_uml
  - deploy_pages

generate_uml:
  stage: generate_uml
  script:
    - mkdir -p public
    - |
      if ! command -v java &> /dev/null; then
        echo "Downloading portable Java..."
        wget -q https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_linux-x64_bin.tar.gz -O /tmp/jdk.tar.gz || curl -L -o /tmp/jdk.tar.gz https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_linux-x64_bin.tar.gz
        tar -xzf /tmp/jdk.tar.gz -C /tmp/
        export JAVA_HOME=/tmp/jdk-11.0.2
        export PATH=$JAVA_HOME/bin:$PATH
      fi
      java -version
      wget -q https://github.com/plantuml/plantuml/releases/download/v1.2024.5/plantuml-1.2024.5.jar -O /tmp/plantuml.jar || curl -L -o /tmp/plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2024.5/plantuml-1.2024.5.jar
      find . -name "*.puml" -type f -print0 | while IFS= read -r -d '' file; do
        echo "Processing: $file"
        java -jar /tmp/plantuml.jar -tsvg -o public "$file"
      done
    - ls -la public/
    - git config --global user.email "gitlab-runner@example.com"
    - git config --global user.name "GitLab Runner"
    - git add public/
    - |
      if git diff --staged --quiet; then
        echo "No changes to commit"
      else
        git commit -m "Auto-generate PlantUML diagrams"
      fi
    - git push origin HEAD || true
  artifacts:
    paths:
      - public/
    expire_in: 1 hour

pages:
  stage: deploy_pages
  dependencies:
    - generate_uml
  script:
    - echo "Деплой на GitLab Pages..."
    - mkdir -p public
  artifacts:
    paths:
      - public
  only:
    - main