stages:
  - upload_sftp

upload_diagrams_sftp:
  stage: upload_sftp
  image: nikolaik/python-nodejs:python3.11-nodejs18
  only:
    changes:
      - sequences/**/*.mermaid
      - scripts/generate_and_upload.py
  cache:
    key: deps-v2
    paths:
      - .pip-cache/
      - .npm-cache/
  before_script:
    - pip install --cache-dir .pip-cache -r requirements.txt
    - npm config set cache .npm-cache --global
    - npm install -g @mermaid-js/mermaid-cli
  script:
    - python scripts/generate_and_upload.py
  artifacts:
    paths:
      - upload_results.json
      - sequences/*.png
    expire_in: 7 days
    when: always
  allow_failure: true
